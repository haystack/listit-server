{% extends "base.html" %}
{% block title %}20 Days{% endblock %}
{% block imports %}
        <link rel="stylesheet" type="text/css" href="/lib/CSS/datepicker.css" />
        <script src="/lib/js/jquery-1.3.2.min.js">
        </script>
        <script src="/lib/js/protocrock.js">
        </script>
        <script src="/lib/js/zamiang.js">
        </script>
        <script src="/lib/js/watchMeGraph.js">
        </script>
        <script src="/lib/js/jquery-ui-1.7.2.custom.min.js">
        </script>
        <script src="/lib/js/datepicker.js">
        </script>
        <script>
            jQuery.noConflict();
        </script>
        <script>
    var WatchmeVisualisation = {
      initialize: function(canvas, windowWidth, windowHeight, timeZoneCorrect, endTime, zoom){
	  var day = 86400000; // 1 day in ms
            this.canvas = canvas;
            this.windowWidth = windowWidth;
            this.windowHeight = windowHeight;
            this.timeZoneCorrect = timeZoneCorrect;
            this.endDate = new Date(endTime);
            this.startDate = new Date(this.endDate.valueOf() - day);
            this.now = new Date(new Date().valueOf() + this.timeZoneCorrect);
            this.endTime = this.endDate.valueOf();
            this.startTime = this.startDate.valueOf();
            this.OGendTime = this.endDate.valueOf();
            this.OGstartTime = this.startDate.valueOf();
            this.drawArray = [];
            
            this.newData = function getViews(startTime, endTime, viz) {
	      // uses the django model get_views to return www viewed events between start and end times
	      try {
		jQuery.get("http://localhost:8000/get_views", {from: startTime, to: endTime},
			   function(data) {
			     if (data.code == 200) {			       
			       createTheWorld(data.results, startTime, endTime, viz);
			     } else {
			       console.log("yaaaa!!!H!H!H!" + data.code + " ");
			     }
			   }, "json");
	      } catch(e) {
		console.log(e);
	      }
	    }(this.endTime - zoom, this.endTime, this); // passing this around like a hot tomalie       

	    var wwwBarsArray = [];
	    function createTheWorld(newData, startTime, endTime, viz){
	      var fooDate = "";
	      var fooTotal = "";
	      for (var i = 0; i < (zoom / day); i++) {
		var fooData = newData.filter(function(view) { 
		  if (view.end < (endTime - (day * i)) && (view.start > (endTime - day - (day * i)))) {
		    return view;
		    } 
		});
                wwwBarsArray[i] = newify(statusFactory, viz, {
		  startTime: endTime - day - (day * i),
		  endTime: endTime - (day * i),
		  xOffset: 0,
		  yOffset: 0,
		  marginTop: 25 * i + 11,
		  height: 20,
		  color: "#0000ff",
		  staticStatic: true,
		  data: fooData
                });
                fooDate += new Date(wwwBarsArray[i].endTime).format('dddd, mmmm d') + "<br />";
                fooTotal += function(){
		  var foo = 1;
		  for (var j = 0; j < wwwBarsArray[i].data.length; j++) {
		    foo += wwwBarsArray[i].data[j].end - wwwBarsArray[i].data[j].start;
		  }
		  return timeCounterLongAbv(foo / 1000) + "<br />";
                }();
	      }	      
	      jQuery("#fooDate").html(fooDate);
	      jQuery("#fooTotal").html(fooTotal);
	      jQuery("#minDate") .html("| "  + (new Date(endTime - 86400000)).format('h:MM TT')); // maxDate minus 24 hours
	      jQuery("#maxDate").html((new Date(endTime).format('h:MM TT')) + " |");
	      jQuery("#minDateTwo") .html("| "  + (new Date(endTime - 86400000)).format('h:MM TT')); // maxDate minus 24 hours
	      jQuery("#maxDateTwo").html((new Date(endTime).format('h:MM TT')) + " |");
	    }
	    this.isStatic = true; // does not move or make more ajax calls
	    mainEvtHandlers = newify(evtHandlers, this);
	    this.drawArray.push(wwwBarsArray);
	    this.draw();
        },
        draw: function(){
            if (this.canvas !== undefined && this.canvas.getContext) {
                var ctx = this.canvas.getContext('2d');
                ctx.clearRect(0, 0, this.windowWidth, this.windowHeight);
                for (var i = 0; i < this.drawArray.length; i++) {
                    for (var k = 0; k < this.drawArray[i].length; k++) {
                        this.drawArray[i][k].draw();
                    }
                }
            }
            else {
                alert('You need Safari 4 or Firefox 3+ to see this.');
            }
        },
	getCanvas: function(){
	  return this.canvas;
	},
	setDrawArray: function(p){
	  this.drawArray = p;
	}
    };


    jQuery(document).ready(function(){
      var currentDate = new Date();
      
      jQuery('#datepicker').DatePicker({
	format:'m/d/Y',
	date: jQuery('#datepicker').val(),
	current: jQuery('#datepicker').val(),
	starts: 1,
	position: 'top',
	current: '2009-07-29',

	onBeforeShow: function(){
	  jQuery('#datepicker').DatePickerSetDate(jQuery('#datepicker').val(), true);
	},
	onChange: function(formated, dates){
	  var fooDate = jQuery.datepicker.formatDate("@", new Date(jQuery('#datepicker').DatePickerGetDate(true)));
	  if  (fooDate > new Date().valueOf()) { 
	    fooDate = new Date().valueOf(); 
	    jQuery('#datepicker').val(currentDate.format('mm/dd/yyyy'));
            jQuery("#messageSent").show("slow");
	  }
	  else {
	    jQuery('#datepicker').val(formated);
	    self.viz = newify(WatchmeVisualisation, document.getElementById("main"), myWidth, myHeight, 0, parseInt(fooDate), 1728000000); // 20 days 1296000000); // 15 days  2592000000); // 30 days	    
	    jQuery("#messageSent").hide("slow");
	  }
	  jQuery('#datepicker').DatePickerHide();

	}
      });
      var myWidth = undefined;
      var myHeight = undefined;
        
        myWidth = window.innerWidth - 400;
        myHeight = 500;//window.innerHeight;
        document.getElementById("main").setAttribute("width", myWidth);
        document.getElementById("main").setAttribute("height", myHeight);
        jQuery("#maxDate").css("width", myWidth - 70);
        jQuery("#maxDateTwo").css("width", myWidth - 70);
	jQuery("#datepicker").val(currentDate.format('mm/dd/yyyy'));

	self.viz = newify(WatchmeVisualisation, document.getElementById("main"), myWidth, myHeight, 0, currentDate.valueOf(), 1728000000); // 20 days 1296000000); // 15 days  2592000000); // 30 days
    });
</script>
{% endblock %}
{% block content %}
<div id="dayHeading">
<div class="centerLabel"></div>
<div id="dateNav" style="display:inline-block; font-size:0.8em; color:#666666;">
<div id="minDate" style="width:100px; display:inline-block"></div>
<div id="maxDate" style="width:100px; float:right; text-align:right; display:inline-block;"></div>
</div>
<div class="centerLabel" style="float:right;"></div>
</div>
        <div id="fooDate" class="days" style="float:left; display:inline-block: width:100px">
        </div>
        <div id="fooTotal" class="days" style="float:right; display:inline-block:width:100px">
        </div>
        <canvas id="main">
        </canvas>
        <div id="fooTxt">
        </div>
<br />
<div class="centerLabel"></div>
<div id="dateNav" style="display:inline-block; font-size:0.8em; color:#666666;">
<div id="minDateTwo" style="width:100px; display:inline-block; margin-left:30px;"></div>
<div id="maxDateTwo" style="width:100px; float:right; text-align:right; display:inline-block;"></div>
</div>
<div id="dateselector">
<input id="datepicker" class="datepicker" value="06/14/2008" type="text" style="padding-top:4px; padding-left:6px; width:70px; height:18px; display:inline-block;"/>
<img src="/lib/img/calendar_16.png" style="vertical-align:middle; margin-left:4px;"/>
<div id="messageSent">robots do not know the future :(</div>

</div>
{% endblock %}
