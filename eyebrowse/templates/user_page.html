{% extends "base.html" %}
{% block title %}{{ username }}{% endblock %}
{% block imports %}
    <style>
	    @import url("/lib/css/datepicker.css");
        #latestlist h6 {
			width: 420px;
		}
	</style>
	<script src="/lib/js/jquery.corner.js">
	</script>
	<script src="/lib/js/watchMeGraph.js">
	</script>
	<script src="/lib/js/canvas.text.js">
	</script>
	<script src="/lib/js/faces/helvetiker-normal-normal.js">
	</script>
	<script src="/lib/js/datepicker.js">
	</script>
	<script>
    var WatchmeVisualisation = {
        initialize: function(canvas, windowWidth, windowHeight, timeZoneCorrect, zoom){
            this.canvas = canvas;
            this.windowWidth = windowWidth;
            this.windowHeight = windowHeight;
            this.timeZoneCorrect = timeZoneCorrect;
            this.endDate = new Date();
			this.now = new Date().valueOf();
            this.startDate = new Date(this.endDate.valueOf() - zoom);
            this.endTime = this.endDate.valueOf();
            this.startTime = this.startDate.valueOf();
            this.OGendTime = this.endDate.valueOf();
            this.OGstartTime = this.startDate.valueOf();
			this.urlID = 0;
            this.interp = zoom / 192;
            this.drag = undefined;
            this.zoom = zoom;
            this.getLatestPages(this.endTime - 86400000, this.endTime); // 1 day
			this.getProfile();
			this.initBarGraphs('{{ username }}'); 
            this.initLiteGraph(this.endTime - 604800000, this.endTime); // 604800000 is 1 week
            this.getTopPages(this.endTime - zoom, this.endTime);
        },
		getProfile: function(){
            try {
                jQuery.get("/get_user_profile_queries/{{ username }}/", {
						   }, function(data){
							   if (data.code == 200) {								   
								   var newData = data.results;	
								   jQuery("#totalTime").html("<b>total time spent: </b> " + timeCounterLongAbv(newData.totalTime));
								   jQuery("#num").html("<b>total visits: </b>" + newData.number);
								   jQuery("#avgTime").html("<b>average time spent: </b>" + timeCounterLongAbv(newData.average));			
							   }
							   else {
								   console.log("yaaaa!!!H!H!H!" + data.code + " ");
							   }
						   }, "json");
            } 
            catch (e) {
                console.log(e);
            }
		},
        drawTopPagesList: function(data){
            var this_ = this;
            var newData = data;
            var html = "<ul>";
            for (var i = 0; i < newData.length; i++) {
                var trigger = true;
                html += "<li>";
                html += "<h6><b><a href=\"http://" + newData[i][0] + "\">" + newData[i][0] + "</a></b></h6>";                
                if (newData[i][2] < 0) {
                    trigger = false;
                    html += "<div class=\"imgbox\">";
                    html += "<img src=\"/lib/img/arrow_full_down_16.png\" />";
                    html += "<b>" + newData[i][2] + "</b>";
                    html += "</div>";
                }
                if (newData[i][2] > 0) {
                    trigger = false;
                    html += "<div class=\"imgbox\">";		   
					html += "<img src=\"/lib/img/arrow_full_up_16.png\" />";                         
					html += "<b>" + newData[i][2] + "</b>";
					html += "</div>";
                }
                if (trigger) {
                    html += "<div class=\"imgbox\">&nbsp;";
                    // html += "<img src=\"/lib/img/star_16.png\" />";
                    html += "</div>";
                }
                html += "<h7>" + timeCounterLong((newData[i][1]) / 1000) + "</h7>";
                html += "</li>";
            }
			html += "</ul>";
            jQuery("#list").html(html);
        },
        getTopPages: function(startTime, endTime, data){
            // uses the django model get_top_pages to return top pages between start and endtime
            var this_ = this;
            try {
				jQuery("#loadimg").show();
                jQuery.get("/get_top_hosts_comparison/{{ username }}/25/", {
							   first_start: startTime - 86400000,
							   first_end: endTime - 86400000,
							   second_start: startTime,
							   second_end: endTime
						   },
						   function(data){
							   jQuery("#loadimg").hide();
							   if (data.code == 200) {
								   this_.drawTopPagesList(data.results);
							   }
							   else {
								   console.log("yaaaa!!!H!H!H!" + data.code + " ");
							   }
						   }, "json");
            } 
            catch (e) {
                console.log(e);
            }
        },
		initBarGraphs: function(user){
			var this_ = this;

            try {
                jQuery.get("/get_day_of_week_graph_for_user/", {
							   user: user
						   }, function(data){
							   if (data.code == 200) {				
								   var dayWeekGraph = newify(barGraphLite, {
																 canvas: document.getElementById("dayWeekGraph"),
																 windowHeight: this_.windowHeight,
																 windowWidth: this_.windowWidth,
																 bottomPadding:30,
																 barPadding:10,
																 textPadding:4,
																 columnWidth:20,																 
																 label: ['Monday', 'Tuesday', 'Wednes', 'Thursday', '  Friday', 'Saturday', 'Sunday'],
																 data: data.results
														 });
							   }
							   else {
								   //console.log("yaaaa!!!H!H!H!" + data.code + " ");
							   }
						   }, "json");
            } 
            catch (e) {
                console.log(e);
            }
            try {
                jQuery.get("/get_time_of_day_graph_for_user/", {
							   user: user
						   }, function(data){
							   if (data.code == 200) {						
								   var timeDayGraph = newify(barGraphLite, {
																 canvas: document.getElementById("dayTimeGraph"),
																 windowHeight: this_.windowHeight,
																 windowWidth: this_.windowWidth,
																 color: "#ff00ff",
																 bottomPadding:30,
																 columnWidth:8,
																 barPadding:0,
																 textPadding:0,
																 label: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],
																 data: data.results
														 });
							   }
							   else {
								   //console.log("yaaaa!!!H!H!H!" + data.code + " ");
							   }
						   }, "json");
            } 
            catch (e) {
                console.log(e);
            }
        },
        initLiteGraph: function(startTime, endTime){
            var this_ = this;
			jQuery("#loadimg").show();
            try {
                jQuery.get("/get_graph_points_user/{{ username }}/28/", {
							   from: startTime,
							   to: endTime
						   }, function(data){
							   if (data.code == 200) {	
								   if (data.results.ttData.length > 0){
									   jQuery("#loadimg").hide();
									   var totalTimeG = newify(lineGraphFactoryLite, {
																   canvas: document.getElementById("totalTimeGraph"),
																   startTime: startTime,
																   endTime: endTime,
																   windowHeight: this_.windowHeight,
																   windowWidth: this_.windowWidth,
																   interp: (endTime - startTime) / 28,
																   color: "#ff00ff",
																   fillGraph: true,
																   data: data.results.ttData
															   });
									   var avgTimeG = newify(lineGraphFactoryLite, {
																 canvas: document.getElementById("avgTimeGraph"),
																 startTime: startTime,
																 endTime: endTime,
																 windowHeight: this_.windowHeight,
																 windowWidth: this_.windowWidth,
																 interp: (endTime - startTime) / 28,
																 color: "#ff00ff",
																 fillGraph: true,
																 data: data.results.avgData
															 });
								   }
							   }
							   else {
								   console.log("yaaaa!!!H!H!H!" + data.code + " ");
							   }
						   }, "json");
            } 
            catch (e) {
                console.log(e);
            }
        },
        drawLatestPagesList: function(data){
			var this_ = this;
            var newData = data;
            var html = "";
			jQuery("#latestlist").html(" ");
			html = "<ul >";
            for (var i = 0; i < newData.length; i++) {
                html += "<li id=\"url" + i +  "\">";
				if (newData[i].title){
					html += "<h6><b><a href=\"" + newData[i].url + "\">" + newData[i].title + "</a></b></h6>";
				}
				else{
					html += "<h6><b><a href=\"" + newData[i].url + "\">" + newData[i].url + "</a></b></h6>";
				}
				html += "<a href=\"javascript:self.viz.deletePage('" + newData[i].id + "','" + i + "');\" style=\"float:right; margin-right:6px; margin-left:6px;\" >";
				html += "<img src=\"/lib/img/cancel_16.png\" /></a>";
                html += "<h7>" + timeCounterLong((this_.now - newData[i].end)/1000) + " <b>ago</b></h7>";
                html += "</li>";
			}
            html += "</ul>";
			jQuery("#latestlist").prepend(html);			
        },
        getLatestPages: function(){
            var this_ = this;
            try {
                jQuery.get("/get_recent_web_page_views_user/{{ username }}/15/", {
								id: this_.urlID
						   }, function(data){
							   if (data.code == 200) {
								   this_.drawLatestPagesList(data.results);
							   }
							   else {
								   console.log("yaaaa!!!H!H!H!" + data.code + " ");
							   }
						   }, "json");
            } 
            catch (e) {
                console.log(e);
            }
        },
		deletePage: function(urlID, num){
			try {
				jQuery.post("/delete_url_entry/", {
							   'ID': "" + urlID
						   }, function(data){							   
							   if (data.code == 200) {
								   jQuery("\#url" + num).hide("slow");
							   }
							   else {
								   console.log("yaaaa!!!H!H!H!" + data.code + " ");
							   }
						   }, "json");
            } 
            catch (e) {
                console.log(e);
            }			
		},
		refresh: function(startTime, endTime){
            var this_ = this;
            this_.endTime = endTime;
            this_.startTime = startTime;
            
            try {
				jQuery("#loadimg").show();
				jQuery.get("/get_top_hosts_comparison/{{ username }}/25/", {
							   first_start: startTime - 86400000,
							   first_end: endTime - 86400000,
							   second_start: startTime,
							   second_end: endTime
						   }, 
						   function(data){
							   jQuery("#loadimg").hide();
							   if (data.code == 200) {
								   this_.drawTopPagesList(data.results);
							   }
							   else {
								   console.log("yaaaa!!!H!H!H!" + data.code + " ");
							   }
						   }, "json");
            } 
            catch (e) {
				console.log(e);
            }
		}
    };


jQuery(document).ready(function(){
						   jQuery(".imgborder").corner();
						   var currentDate = new Date();
						   jQuery("#datepicker").val(currentDate.format('mm/dd/yyyy'));						   
						   jQuery("#datepicker").DatePicker({
																format: 'm/d/Y',
																date: jQuery('#datepicker').val(),
																current: jQuery('#datepicker').val(),
																starts: 1,
																position: 'top',
																current: '2009-07-29',
																
																onBeforeShow: function(){
																	jQuery('#datepicker').DatePickerSetDate(jQuery('#datepicker').val(), true);
																},
																onChange: function(formated, dates){
																	var fooDate = jQuery.datepicker.formatDate("@", new Date(jQuery('#datepicker').DatePickerGetDate(true)));
																	if (fooDate > new Date().valueOf()) {
																		fooDate = new Date().valueOf();
																		jQuery('#datepicker').val(currentDate.format('mm/dd/yyyy'));
																		jQuery("#messageSent").show("slow");
																	}
																	else {
																		jQuery('#datepicker').val(formated);
																		self.viz.refresh(parseInt(fooDate) - self.viz.zoom, parseInt(fooDate)), jQuery("#messageSent").hide("slow");
																	}
																	jQuery('#datepicker').DatePickerHide();
																}
															});						  						 						   

						   jQuery("#datepickergraph").val(currentDate.format('mm/dd/yyyy'));						   
						   jQuery("#datepickergraph").DatePicker({
																format: 'm/d/Y',
																date: jQuery('#datepickergraph').val(),
																current: jQuery('#datepickergraph').val(),
																starts: 1,
																position: 'top',
																current: '2009-07-29',
																
																onBeforeShow: function(){
																	jQuery('#datepickergraph').DatePickerSetDate(jQuery('#datepickergraph').val(), true);
																},
																onChange: function(formated, dates){
																	var fooDate = jQuery.datepicker.formatDate("@", new Date(jQuery('#datepickergraph').DatePickerGetDate(true)));
																	if (fooDate > new Date().valueOf()) {
																		fooDate = new Date().valueOf();
																		jQuery('#datepickergraph').val(currentDate.format('mm/dd/yyyy'));
																		jQuery("#messageSent").show("slow");
																	}
																	else {
																		jQuery('#datepickergraph').val(formated);
																		self.viz.initLiteGraph(parseInt(fooDate) - self.viz.zoom, parseInt(fooDate)), jQuery("#messageSent").hide("slow");
																		//self.viz.initBarGraphs('{{ username }}'); 
																	}
																	jQuery('#datepickergraph').DatePickerHide();
																}
															});						  						 						   
						   var myWidth = undefined;
						   var myHeight = undefined;
						   
						   myWidth = window.innerWidth - 16;
						   myHeight = window.innerHeight - 250;
						   
						   document.getElementById("dayTimeGraph").setAttribute("width", 335);
						   document.getElementById("dayTimeGraph").setAttribute("height", 200);
						   document.getElementById("dayWeekGraph").setAttribute("width", 335);
						   document.getElementById("dayWeekGraph").setAttribute("height", 200);

						   document.getElementById("totalTimeGraph").setAttribute("width", 335);
						   document.getElementById("totalTimeGraph").setAttribute("height", 200);
						   document.getElementById("avgTimeGraph").setAttribute("width", 335);
						   document.getElementById("avgTimeGraph").setAttribute("height", 200);
						   
						   self.viz = newify(WatchmeVisualisation, document.getElementById("main"), 335, 200, 0, 604800000);// 1 week
					   });
</script>
{% endblock %}
{% block content %}
<div class="loader" id="loadimg"></div>
<div id="report">
	<img src="/lib/img/ajax-loader.gif" class="loader" />
	<div id="loading" class="loader"></div>
    <div id="profile">
        {% if user.username %}
        {% if is_friend %}
        {% else %}
		{% ifequal user.username username %}
        {% else %}<a href="/friend/add?username={{ username }}">follow {{ username }} <img src="/lib/img/accept_16.png" style="width:11px;height:11px;vertical-align:middle"/></a>
        {% endifequal %}
        {% endif %}
        {% endif %}

        <div id="num" style="margin-top:10px;">
            <b>total visits:</b>
        </div>
        <div id="totalTime">
            <b>total time spent: </b>
        </div>
        <div id="avgTime">
            <b>average time spent:</b>
        </div>
        <br />
        {% if location %}<b>Location:</b>
        {{ location }} 
        <br/>
        {% endif %}

        {% if tags %}<b>Tags:</b>
        {{ tags }} 
        <br/>
        {% endif %}

        {% if birthdate %}<b>Age:</b>
        {{ birthdate }} 
        <br/>
        {% endif %}

        {% if homepage %}<b>Website:</b>
        <a href="{{ homepage }}">{{ homepage }}</a> 
        <br/>
        {% endif %}

        <h2>Followers</h2>
        {% if followers %}
        <ul class="friends" style="margin-top:10px">
            {% for friend in followers %}
            <li>
                <a href="/profile/{{ friend.username }}/">{{ friend.username }}</a><h7> {{ friend.number }}</h7>
            </li>
            {% endfor %}
        </ul>
        {% ifequal user.username username %}<div class="footer"><a href="/friends/manage/{{ username }}/">view all of your followers</a></div>
        {% else %}
        {% endifequal %}
        {% else %}
        <p>
            {{ username }} has no followers :(
        </p>
        {% endif %}

        <h2>Following</h2>
        {% if following %}
        <ul class="friends" style="margin-top:10px;">
            {% for friend in following %}
            <li>
                <a href="/profile/{{ friend.username }}/">{{ friend.username }}</a><h7> {{ friend.number }}</h7>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>
            {{ username }} is not following anyone :(
        </p>
        {% endif %}
    </div>
    <div id="profile_content">
	  {% if photo %}
	  <div class="imgborder" style="display:inline-block;">
      <img src="/profiles/{{ id }}.jpg" class="profileimage" />
	  </div>
	  {% endif %}
      <div class="userhead">
        <h1><a href="/profile/{{ username }}/">{{ username }}</a></h1>
        <br/>
        <div class="underuser">
          <a href="/profile/{{ username }}/">profile</a>&nbsp; &#124; &nbsp;<a href="/graph/{{ username }}/">graphs</a>&nbsp; &#124; &nbsp;<a href="/friends/{{ username }}/">friends</a>
        </div>
      </div>
      <br/>
      <div id="listNav">
        <div class="user_page_top">
		  <h2>Latest</h2>		  
        </div>
	  </div>
      <div class="viewboxprofile" id="latestlist">
      </div>
	  <br />
      <div id="listNav">
        <div class="user_page_top">
          <div id="dateselector" style="float:right; margin-top:15px; width:193px;">week ending:
            <input id="datepickergraph" class="datepicker" value="06/14/2008" type="text" style="font-size:12px;padding-top:4px; padding-left:6px; width:70px; height:18px; display:inline-block;"/><img src="/lib/img/calendar_16.png" style="vertical-align:middle; margin-left:4px;"/>
            <div id="messageSentGraph"  style="font-size:12px; display:none";>
              robots do not know the future :( 
              <br/>
              &#8230;yet
            </div>
          </div>
		  <h2>Graphs</h2>
		</div>
		<br />
    <div id="key" style="margin-top:-7px;margin-bottom:4px">
      <div id="totalGraphKey" style="width:300px; text-align:center; display: inline-block;">
        number of visits per hour of day
      </div>
      <div id="avgGraphKey" style="float:right; width:300px; text-align:center; display: inline-block;">
        number visits per day of week
      </div>
    </div>   

    <canvas id="dayTimeGraph" style="border-bottom:px solid lightgrey; margin: 0px; display: inline-block">
    </canvas>
    <canvas id="dayWeekGraph" style="border-bottom:0px solid lightgrey; margin: 0px; margin-left:24px; display: inline-block">
    </canvas>
	<br /><br />
    <canvas id="totalTimeGraph" style="border-bottom:px solid lightgrey; margin: 0px; display: inline-block">
    </canvas>
    <canvas id="avgTimeGraph" style="border-bottom:0px solid lightgrey; margin: 0px; margin-left:24px; display: inline-block">
    </canvas>
    <div id="key" style="margin-top:-40px">
      <div id="totalGraphKey" style="width:300px; text-align:center; display: inline-block;">
        total time spent
      </div>
      <div id="avgGraphKey" style="float:right; width:300px; text-align:center; display: inline-block;">
        average time spent
      </div>
    </div>   
        <div id="listNav">
          <div class="user_page_top">
            <div id="dateselector" style="float:right; margin-top:15px; width:193px;">week ending:
              <input id="datepicker" class="datepicker" value="06/14/2008" type="text" style="font-size:12px;padding-top:4px; padding-left:6px; width:70px; height:18px; display:inline-block;"/><img src="/lib/img/calendar_16.png" style="vertical-align:middle; margin-left:4px;"/>
              <div id="messageSent"  style="font-size:12px";>
                robots do not know the future :( 
                <br/>
                &#8230;yet
              </div>
            </div>
            {% ifequal user.username username %}<h2>Your Top 25</h2>
            {% else %}{% if user.username %}
			<h2 style="font-size:14px;padding-top:12px;padding-bottom:12px">
              <a href="#top10" onclick="window.viz.top()">top 25</a>&nbsp; &#124; &nbsp;<a href="#themMinusYou" onclick="window.viz.themMinusYou()">{{ username }} vs you</a>&nbsp; &#124; &nbsp;<a href="#youMinusThem" onclick="window.viz.youMinusThem ()">you vs {{ username }}</a>
			</h2>
          </div>
          {% else %}<h2>{{ username}}'s top 25</h2>
          {% endif %}
          {% endifequal %}
        </div>
        <div class="viewboxlarge" id="list" style="width:700px;">
        </div>
      </div>
      <br/>
	</div>
	{% endblock %}
	
