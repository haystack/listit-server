{% extends "base.html" %}
{% block title %}Graph{% endblock %}
{% block imports %}
<link rel="stylesheet" type="text/css" href="/lib/CSS/datepicker.css" />
<script src="/lib/js/watchMeGraph.js">
</script>
<script src="/lib/js/canvas.text.js">
</script>
<script src="/lib/js/faces/helvetiker-normal-normal.js">
</script>
<script src="/lib/js/datepicker.js">
</script>
<script>
    jQuery.noConflict();
</script>
<script>
    var WatchmeVisualisation = {
        initialize: function(canvas, windowWidth, windowHeight, timeZoneCorrect, endTime, zoom, data, startDate){
            this.canvas = canvas;
            this.windowWidth = windowWidth;
            this.windowHeight = windowHeight;
            this.timeZoneCorrect = timeZoneCorrect;
            this.endDate = new Date(endTime);
            if (startDate) {
                this.startDate = new Date(startDate + this.timeZoneCorrect);
                zoom = this.endDate - this.startDate;
            }
            else {
                this.startDate = new Date(this.endDate.valueOf() - zoom + this.timeZoneCorrect);
            }
            this.now = new Date(new Date().valueOf() + this.timeZoneCorrect);
            this.endTime = this.endDate.valueOf();
            this.startTime = this.startDate.valueOf();
            this.OGendTime = this.endDate.valueOf();
            this.OGstartTime = this.startDate.valueOf();
            this.interp = zoom / 168;
            this.drag = undefined;
            this.zoom = zoom;
            this.drawArray = [];
            this.marginLeft = 0;
            this.user = "{{ username }}";
            
            this.newData = function getViews(startTime, endTime, viz){
                // uses the django model get_views to return www viewed events between start and end times
				jQuery("#loadimg1").show();
                try {
                    jQuery.get("http://localhost:8000/get_views_user/{{ username }}/", {
                        from: startTime,
                        to: endTime
                    }, function(data){
						jQuery("#loadimg1").hide();
                        if (data.code == 200) {
							if (data.results.length > 0){							
								viz.createTheWorld(data.results, startTime, endTime, viz);
							}
                        }
                        else {
                            console.log("yaaaa!!!H!H!H!" + data.code + " ");
                        }
                    }, "json");
                } 
                catch (e) {
                    console.log(e);
                }
            }(this.startTime, this.endTime, this); // passing this around like a hot tomalie       
        },
        createTheWorld: function(newData, startTime, EndTime, viz){
            var dateSliderArray = [];
            var lineGraphArray = [];
            var statusArray = [];
            
            var wwwBars = newify(statusFactory, this, {
                startTime: this.startTime,
                endTime: this.endTime,
                xOffset: 0,
                yOffset: 0,
                marginTop: this.windowHeight - 85,
                height: 20,
                color: "#0000ff",
                data: newData
            });
            statusArray.push(wwwBars);
            
            var todayGraph = newify(lineGraphFactory, this, {
                xOffset: 0,
                yOffset: 0,
                topPadding: 20,
                padding: this.windowHeight - 93,
                color: "#00ffff",
                dashed: false,
                key: true,
                avg: false,
                data: newData,
            	label: "websites viewed"
            });
            lineGraphArray.push(todayGraph);
            
            var mainDateSlider = newify(dateSlider, this, {
                xOffset: 0,
                yOffset: 0,
                padding: 55
            });
            dateSliderArray.push(mainDateSlider);
            
            this.drawArray.push(lineGraphArray);
            this.drawArray.push(dateSliderArray);
            this.drawArray.push(statusArray);
            
            
            var mainEvtHandlers = newify(evtHandlers, this);
            
            this.draw();
        },
        draw: function(){
            if (this.canvas !== undefined && this.canvas.getContext) {
                var ctx = this.canvas.getContext('2d');
                ctx.clearRect(0, 0, this.windowWidth, this.windowHeight);
                for (var i = 0; i < this.drawArray.length; i++) {
                    for (var k = 0; k < this.drawArray[i].length; k++) {
                        this.drawArray[i][k].draw();
                    }
                }
            }
            else {
                alert('You need Safari 4 or Firefox 3+ to see this.');
            }
        },
        getCanvas: function(){
            return this.canvas;
        },
        setDrawArray: function(p){
            this.drawArray = p;
        },
        refresh: function(endTime, startTime){
            var this_ = this;
            this_.endTime = endTime;
            this_.startTime = startTime;
            this_.OGendTime = endTime;
            this_.OGstartTime = startTime;
            
            var data = function(startTime, endTime, viz){
                // uses the django model get_views to return www viewed events between start and end times
                try {
					jQuery("#loadimg1").show();
                    jQuery.get("http://localhost:8000/get_views_user/{{ username }}/", {
								   from: startTime,
								   to: endTime
							   }, function(data){
								   jQuery("#loadimg1").hide();
								   if (data.code == 200) {
									   if(data.results.length > 0){
										   for (var i = 0; i < this_.drawArray.length; i++) {
											   for (var k = 0; k < this_.drawArray[i].length; k++) {
												   this_.drawArray[i][k].mouseUp({
																					 p: 0,
																					 newData: data.results
																				 });
											   }
										   }
									   }
								   }
								   else {
									   console.log("yaaaa!!!H!H!H!" + data.code + " ");
								   }
							   }, "json");
                } 
                catch (e) {
                    console.log(e);
                }
            }(startTime, endTime, this_); // passing this around like a hot tomalie       	    
        },
		arrowBack: function(){
			var this_ = this;		
			jQuery("#datepicker").val(new Date(this_.endTime - 860000000).format('mm/dd/yyyy'));
			this_.refresh(this_.endTime - 860000000, this_.startTime - 860000000);
		},
		arrowForward: function(){
			var this_ = this;
			jQuery("#datepicker").val(new Date(this_.endTime + 860000000).format('mm/dd/yyyy'));
			this_.refresh(this_.endTime + 860000000, this_.startTime + 860000000);
		},
    };
    
    
    jQuery(document).ready(function(){
        // init the datepicker
        var currentDate = new Date();
        jQuery("#datepicker").val(currentDate.format('mm/dd/yyyy'));
        
        jQuery('#datepicker').DatePicker({
            format: 'm/d/Y',
            date: jQuery('#datepicker').val(),
            current: jQuery('#datepicker').val(),
            starts: 1,
            position: 'top',
            current: '2009-07-29',
            
            onBeforeShow: function(){
                jQuery('#datepicker').DatePickerSetDate(jQuery('#datepicker').val(), true);
            },
            onChange: function(formated, dates){
                var fooDate = jQuery.datepicker.formatDate("@", new Date(jQuery('#datepicker').DatePickerGetDate(true)));
                if (fooDate > new Date().valueOf()) {
                    fooDate = new Date().valueOf();
                    jQuery('#datepicker').val(currentDate.format('mm/dd/yyyy'));
                    jQuery("#messageSent").show("slow");
                }
                else {
                    jQuery('#datepicker').val(formated);
                    self.viz.refresh(parseInt(fooDate), parseInt(fooDate) - self.viz.zoom), jQuery("#messageSent").hide("slow");
                }
                jQuery('#datepicker').DatePickerHide();
                
            }
        });
        
        
        var myWidth = undefined;
        var myHeight = undefined;
        
        myWidth = window.innerWidth - 16;
        myHeight = window.innerHeight - 250;
        
        document.getElementById("main").setAttribute("width", myWidth);
        document.getElementById("main").setAttribute("height", myHeight);
        
        self.viz = newify(WatchmeVisualisation, document.getElementById("main"), myWidth, myHeight, 0, currentDate.valueOf(), 604800000); // 1 week
    });
</script>
{% endblock %}
{% block content %}
	<div class="loader" id="loadimg1"></div>
<canvas id="main">
</canvas>
<div class="fooTxt" id="fooTxt">
</div>
<div id="fooDate">
</div>

<div id="dateselector">
<a href="javascript:self.viz.arrowBack()"><img src="/lib/img/arrow_sans_left_16.png" style="vertical-align:middle"/></a>
    <input id="datepicker" class="datepicker" value="06/14/2008" type="text"/>
<a href="javascript:self.viz.arrowForward()"><img src="/lib/img/arrow_sans_right_16.png" style="vertical-align:middle"/></a>
    <div id="messageSent">
        robots do not know the future :( 
        <br/>
        &#8230;yet
    </div>

    {% ifnotequal request_user username %}
    <br/>
    <div class="underuser" style="margin-top:13px; margin-bottom:8px;">
        <h3 style="display:inline-block; font-size:1.1em"><a href="/profile/{{ username }}/" style="text-decoration:none">{{ username }}</a>&#58;&nbsp;</h3>
        <a href="/graph/{{ username }}/">timeline</a>&nbsp; &#124; &nbsp;<a href="/days/{{ username }}/">20 days</a>&nbsp; &#124; &nbsp;<a href="/friends/{{ username }}/">friends</a>
        {% endifnotequal %}
    </div>
</div>
{% endblock %}
