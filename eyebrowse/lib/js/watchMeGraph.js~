// Graphing Library by Brennan Moore
// DEPENDENCIES
/*
 <script src="lib/js/jquery-1.3.2.min.js">
 </script>
 <script src="lib/js/datepicker.js">
 </script>
 <script src="lib/js/protocrock.js">
 </script>
 <script src="lib/js/zamiang.js">
 </script>
 <script src="lib/js/canvas.text.js">
 </script>
 <script src="lib/js/faces/helvetiker-normal-normal.js">
 </script>
 <script>
 jQuery.noConflict();
 </script>
 */
var evtHandlers = ({
    mouse: {
        x: 0,
        y: 0
    },
    initialize: function(viz){
        this.viz = viz;
        this.canvas = viz.getCanvas();
        this.startTime = viz.startTime;
        this.endTime = viz.endTime;
        this.OGstartTime = this.startTime;
        this.OGendTime = this.endTime;
        this.dragBeginX = 0;
        this._ev_handlers();
    },
    _ev_handlers: function(){
        var canvas = this.canvas;
        var this_ = this;
        
        jQuery(canvas).mousemove(function(evt){
            var position = jQuery(canvas).position();
            var height = jQuery(canvas).height();
            var ctx = canvas.getContext('2d');
            
            this_.mouse = {
                x: evt.clientX - position.left,
                y: evt.clientY - position.top
            };
            
            if (this_.viz.drag) {
                this_.viz.startTime -= 24000 * (this_.mouse.x - this_.dragBeginX);
                this_.viz.endTime -= 24000 * (this_.mouse.x - this_.dragBeginX);
                if (this_.viz.endTime >= this_.viz.now) {
                    this_.viz.endTime = this_.viz.now.valueOf();
                }
                if ((this_.viz.endTime - 86400000) < this_.viz.startTime) {
                    this_.viz.startTime = this_.viz.now - 86400000;
                }
                this_.startTime = this_.viz.startTime;
                this_.endTime = this_.viz.endTime;
            }
            for (var i = 0; i < this_.viz.drawArray.length; i++) {
                for (var k = 0; k < this_.viz.drawArray[i].length; k++) {
                    this_.viz.drawArray[i][k].mouseMove({
                        mouseVal: this_.mouse
                    });
                }
            }
            this_.viz.draw();
        });
        jQuery(canvas).mousedown(function(evt){
            this_.viz.drag = true;
            this_.dragBeginX = this_.mouse.x;
            for (var i = 0; i < this_.viz.drawArray.length; i++) {
                for (var k = 0; k < this_.viz.drawArray[i].length; k++) {
                    this_.viz.drawArray[i][k].mouseDown({
                        mouseVal: this_.mouse
                    });
                }
            }
        });
        jQuery(canvas).mouseup(function(evt){
	  if (this_.viz.drag) {
	    this_.viz.drag = false;
	    var p = -(1200 * (this_.mouse.x - this_.dragBeginX));
	    if (p > 0){	      
	      var newData = this_.viz.listit.CMS.event_store.getEvents("www-viewed", [this_.OGendTime, this_.endTime]);
	    } else {
	      var newData = this_.viz.listit.CMS.event_store.getEvents("www-viewed", [this_.startTime, this_.OGstartTime]);
	    }
            for (var i = 0; i < this_.viz.drawArray.length; i++) {
	      for (var k = 0; k < this_.viz.drawArray[i].length; k++) {
		this_.viz.drawArray[i][k].mouseUp({p: p, newData: newData});
	      }
	    }
	    this_.OGstartTime = this_.startTime;
	    this_.OGendTime = this_.endTime;
	  }
	  else {
	    this_.viz.drag = false;
	  }
        });
    },
    addNew: function(){
        var this_ = this;
        /*
        // add status
        var newWebViewed = function(){
            if (this_.startTime > this_.viz.startTime) {
                return this_.viz.listit.CMS.event_store.getEvents("www-viewed", [this_.viz.startTime, this_.startTime]);
            }
            if (this_.endTime < this_.viz.endTime) {
                return this_.viz.listit.CMS.event_store.getEvents("www-viewed", [this_.endTime, this_.viz.endTime]);
            }
            else {
                return false;
            }
        }();
        for (var i = 0; i < newWebViewed.length; i++) {
            newWebViewed[i].host = newify(statusFactory, this_.viz, {
                name: newWebViewed[i].entity.id,
                data: newWebViewed[i].entity.host,
                type: newWebViewed[i].type,
                startPoint: newWebViewed[i].start,
                endPoint: newWebViewed[i].end,
                xOffset: 0,
                yOffset: 0,
                marginTop: this_.viz.windowHeight - 76,
                height: 10,
                color: "#0000ff",
                lableOn: false
            });
            this_.viz.drawArray[i].push(newWebViewed[i].host);
        }
        this_.viz.drawArray[1] = this_.viz.drawArray[1].filter(function(p){
            if (p.OGendPoint < this_.viz.startTime && p.OGstartPoint < this_.viz.endTime) {
                return false;
            }
            return true;
        });
        this_.viz.setDrawArray(this_.viz.drawArray);
	*/
    }
});


///
///
///
var dateSlider = ({
    initialize: function(viz, params){
        this.viz = viz;
        this.canvas = viz.getCanvas();
        this.startDate = viz.startDate;
        this.endDate = viz.endDate;
        this.startTime = viz.startTime;
        this.endTime = viz.endTime;
        this.OGstartTime = viz.startTime;
        this.OGendTime = viz.endTime;
        this.windowHeight = viz.windowHeight;
        this.windowWidth = viz.windowWidth;
        this.xOffset = params.xOffset;
        this.yOffset = params.yOffset;
        this.padding = params.padding;
        this.rightSlider = Math.round(-this.windowWidth * ((this.startTime + 5 - this.endTime) / (this.endTime - this.startTime)));
        this.leftSlider = Math.round(-this.windowWidth * ((this.startTime + 5 - this.startTime) / (this.endTime - this.startTime)));
        this.sliderTriTop = -2;
        this.sliderTriBottom = 8;
        this.sliderTriHeight = this.sliderTriBottom - this.sliderTriTop;
        this.sliderTriWidth = 10;
        this.lSP = rectToPoly({
            xPos: this.leftSlider + this.xOffset,
            yPos: this.windowHeight - this.padding + this.sliderTriTop + this.yOffset,
            height: this.sliderTriHeight,
            width: this.sliderTriWidth
        });
        this.rSP = rectToPoly({
            xPos: this.rightSlider + this.xOffset - this.sliderTriWidth,
            yPos: this.windowHeight - this.padding + this.sliderTriTop + this.yOffset,
            height: this.sliderTriHeight,
            width: this.sliderTriWidth
        });
        this.lIS = undefined; // is selected
        this.rIS = undefined;
        this.lIH = undefined; // is hover
        this.rIH = undefined;
        this.trigger = false;
        
        this.zoomPlusPoly = circleToPoly({
            xPos: 50,
            yPos: this.padding + 20,
            size: 8
        });
        this.zoomMinusPoly = circleToPoly({
            xPos: 50,
            yPos: this.padding + 120,
            size: 8
        });
        this.zoom = 0;        
        this.startDateSelect = false;
        this.startDateTrigger = false;
        this.endDateTrigger = false;
        this.startDateSelectPoly = rectToPoly({
            xPos: 10,
            yPos: this.windowHeight - this.padding + 40,
            height: 20,
            width: 130
        });
        this.endDateSelectPoly = rectToPoly({
            xPos: this.windowWidth - 130,
            yPos: this.windowHeight - this.padding + 40,
            height: 20,
            width: 120
        });
    },
    draw: function(){
        var ctx = this.canvas.getContext('2d');
        var this_ = this;
        
        // check to see if there is a new value for max date time
        if ((this_.startTime !== this_.viz.startTime) || (this_.endTime !== this_.viz.endTime)) {
            // redefine the values
            this_.startDate = new Date(this_.viz.startTime);
            this_.endDate = new Date(this_.viz.endTime);
            this_.startTime = this_.viz.startTime;
            this_.endTime = this_.viz.endTime;
        }
	ctx.font = "0.8pt helvetiker";

        // zoomZoom
        ctx.beginPath();
        ctx.fillStyle = "#000000";
        ctx.fillRect(50, this_.padding + 20, 2, 100)
        
        ctx.fillStyle = "#ffffff";
        ctx.strokeStyle = "#000000";
        ctx.lineWidth = 0.5;
        
        ctx.beginPath();
        ctx.arc(50, this_.padding + 20, 6, 0, Math.PI * 2, true);
        ctx.fill();
        ctx.stroke();
        ctx.closePath();
        
        ctx.beginPath();
        ctx.arc(50, this_.padding + 120, 6, 0, Math.PI * 2, true);
        ctx.fill();
        ctx.stroke();
        ctx.closePath();
        ctx.fillStyle = "#000000";
        
        ctx.fillRect(47, this_.padding + 20, 7, 1);
        ctx.fillRect(50, this_.padding + 16, 1, 7);
        
        ctx.fillRect(47, this_.padding + 120, 6, 1);
        ctx.closePath();
        
        
        
        // date lines
        ctx.lineWidth = 1;
        ctx.strokeStyle = "#0f0f0f";
        
        var fooHour = 0;
        var fooDateVal = ((Math.floor(this_.endTime / (this_.viz.zoom / 12))) * (this_.viz.zoom / 12)); // 2 hours
        for (var hourCount = 0; hourCount < 14; hourCount++) {
            var dayText = new Date(fooDateVal - fooHour);
            var q = this_.windowWidth * ((fooDateVal - fooHour - this_.startDate) / (this_.endDate - this_.startDate)); //- startTime) / (endTime - startTime)); // make dates not move >> - initDateMin) / (initDateMax - initDateMin));
            ctx.beginPath();
            ctx.moveTo(q, this_.windowHeight - this_.padding + 16);
            ctx.lineTo(q, this_.windowHeight - this_.padding + 21);
            ctx.closePath();
            ctx.stroke();
            ctx.fillStyle = "#999999";
            if ((this_.viz.zoom / 12) <= 7200000) {
                ctx.fillText(dayText.format('h:MM TT'), q + 10, this_.windowHeight - this_.padding + 21);
            }
            else {
                ctx.fillText(dayText.format('mmmm d h:MM TT'), q + 10, this_.windowHeight - this_.padding + 21);
            }
            fooHour += (this_.viz.zoom / 12); // 7200000	
        }
        
        
        // lines for date nav min/max
        ctx.beginPath();
        ctx.lineWidth = 1;
        ctx.strokeStyle = "#000000";
        ctx.fillStyle = "#000000";
        ctx.fillText(this_.startDate.format('dddd, mmmm d h:MM TT'), 10, this_.windowHeight - this_.padding + 40);
        ctx.fillText(this_.endDate.format('dddd, mmmm d h:MM TT'), this_.windowWidth - 130, this_.windowHeight - this_.padding + 40);
        ctx.closePath();
        
        // ROLLOVERS
        if ((this_.rIH) || (this_.rIS)) {
            var fooDate = new Date(this_.startTime + ((this_.endTime - this_.startTime) * (this_.rightSlider / this_.windowWidth)));
            jQuery("#fooTxt").html("<div class=\"friendStatus\" style=\"top:" + (this_.windowHeight - this_.padding - 3) + "px; left:" + (this_.rightSlider - 145) + "px; background:#000000; color:#ffffff; padding:3px; width:auto \">" + fooDate.format('dddd, mmmm dS, h:MM TT') + "</div>");
            this_.trigger = true;
            
            ctx.beginPath();
            ctx.fillStyle = "rgba(255,255,255,0.9)";
            ctx.fillRect(this_.leftSlider, this_.padding, this_.rightSlider - this_.leftSlider, this_.windowHeight - (this_.padding * 2));
            ctx.closePath();
            
            var testPaths = [], spacing = 2, firstDistance = 0, drawFirst = false, ctx, animating = false, pointerX = pointerY = 0, canvasOffset;
            testPaths[0] = [new Path([new Bezier([new Point(this_.rightSlider, this_.windowHeight - this_.padding), new Point(this_.rightSlider, this_.padding)])])];
            
            ctx.beginPath();
            ctx.lineWidth = 1;
            testPaths.each(function(paths){
                paths.each(function(path){
                    path.makeDashedPath(ctx, spacing, firstDistance);
                });
            });
            ctx.stroke();
            ctx.closePath();
        }
        if ((this_.lIH) || (this_.lIS)) {
            var fooDate = new Date(this_.startTime + ((this_.endTime - this_.startTime) * (this_.leftSlider / this_.windowWidth)));
            jQuery("#fooTxt").html("<div class=\"friendStatus\" style=\"top:" + (this_.windowHeight - this_.padding - 3) + "px; left:" + (this_.leftSlider + 45) + "px; background:#000000; color:#ffffff; padding:3px; width:auto \">" + fooDate.format('dddd, mmmm dS, h:MM TT') + "</div>");
            this_.trigger = true;
            
            ctx.beginPath();
            ctx.fillStyle = "rgba(255,255,255,0.9)";
            ctx.fillRect(this_.leftSlider, this_.padding, this_.rightSlider - this_.leftSlider, this_.windowHeight - (this_.padding * 2));
            ctx.closePath();
            
            var testPaths = [], spacing = 2, firstDistance = 0, drawFirst = false, ctx, animating = false, pointerX = pointerY = 0, canvasOffset;
            testPaths[0] = [new Path([new Bezier([new Point(this_.leftSlider, this_.windowHeight - this_.padding), new Point(this_.leftSlider, this_.padding)])])];
            
            ctx.beginPath();
            ctx.lineWidth = 1;
            testPaths.each(function(paths){
                paths.each(function(path){
                    path.makeDashedPath(ctx, spacing, firstDistance);
                });
            });
            ctx.stroke();
            ctx.closePath();
        }
        if ((this_.lIS) || (this_.rIS)) {
            this_.drawBarGraph();
        }
        
        
        // line showing width
        ctx.beginPath();
        ctx.strokeStyle = "#000000";
        ctx.moveTo(0, this_.windowHeight - this_.padding - 2);
        ctx.lineTo(this_.windowWidth, this_.windowHeight - this_.padding - 2);
        ctx.lineWidth = 2.5;
        ctx.stroke();
        ctx.closePath();
        
        
        // right triangle
        ctx.beginPath();
        ctx.moveTo(this_.rightSlider, this_.windowHeight - this_.padding - 2);
        ctx.lineTo(this_.rightSlider - this_.sliderTriWidth, this_.windowHeight - this_.padding - this.sliderTriWidth - 2);
        ctx.lineTo(this_.rightSlider - this_.sliderTriWidth, this_.windowHeight - this_.padding + this.sliderTriWidth - 2);
        ctx.lineTo(this_.rightSlider, this_.windowHeight - this_.padding - 2);
        ctx.fillStyle = "#000000";
        if (this_.rIH) {
            ctx.fillStyle = "#cc006b";
        }
        ctx.fill();
        ctx.closePath();
        
        // left triangle
        ctx.beginPath();
        ctx.moveTo(this_.leftSlider, this_.windowHeight - this_.padding - 2);
        ctx.lineTo(this_.leftSlider + this_.sliderTriWidth, this_.windowHeight - this_.padding - this.sliderTriWidth - 2);
        ctx.lineTo(this_.leftSlider + this_.sliderTriWidth, this_.windowHeight - this_.padding + this.sliderTriWidth - 2);
        ctx.lineTo(this_.leftSlider, this_.windowHeight - this_.padding - 2);
        
        ctx.fillStyle = "#000000";
        if (this_.lIH) {
            ctx.fillStyle = "#cc006b";
        }
        ctx.fill();
        ctx.closePath();
    },
    mouseMove: function(params){
        var this_ = this;
        
        this_.rIH = isPointInPoly(this_.rSP, params.mouseVal);
        this_.lIH = isPointInPoly(this_.lSP, params.mouseVal);
        
        if (this_.rIS) {
            this_.rightSlider = params.mouseVal.x;
        }
        if (this_.lIS) {
            this_.leftSlider = params.mouseVal.x;
        }
        if ((this_.lIS) || (this_.rIS)) {
            this_.viz.drag = false;
            this_.leftSliderDate = new Date(this_.startTime + ((this_.endTime - this_.startTime) * (this_.leftSlider / this_.windowWidth)));
            this_.rightSliderDate = new Date(this_.startTime + ((this_.endTime - this_.startTime) * (this_.rightSlider / this_.windowWidth)));
        }
        
        if (!(this_.lIH || this_.lIS) && !(this_.rIH || this_.rIH) && this_.trigger) {
            this_.trigger = false;
            jQuery("#fooTxt").html("");
        }
    },
    mouseDown: function(params){
        var this_ = this;
        
        if (this_.rIH) {
            this_.rIS = true;
        }
        if (this_.lIH) {
            this_.lIS = true;
        }
        if ((this_.lIS) || (this_.rIS)) {
            this_.leftSliderDate = new Date(this_.startTime + ((this_.endTime - this_.startTime) * (this_.leftSlider / this_.windowWidth)));
            this_.rightSliderDate = new Date(this_.startTime + ((this_.endTime - this_.startTime) * (this_.rightSlider / this_.windowWidth)));
            this_.initBarGraph({
                canvas: this_.canvas
            });
        }
        if (isPointInPoly(this_.zoomPlusPoly, params.mouseVal)) {
            this_.zoomZoom(-1);
        }
        
        if (isPointInPoly(this_.zoomMinusPoly, params.mouseVal)) {
            this_.zoomZoom(1);
        }
        
        this_.dateTrigger = false;
        if (isPointInPoly(this_.startDateSelectPoly, params.mouseVal)) {
            jQuery("#fooDate").html("<div id=\"navDateCal\" style=\"position: absolute; top:" + (this_.windowHeight - this.padding - 100) + "px; left:" + (params.mouseVal.x - 50) + "px; width:auto\"></div>");
            jQuery('#navDateCal').DatePicker({
                flat: true,
                date: this.startDate.format('yyyy-mm-dd'),
                current: this.startDate.format('yyyy-mm-dd'),
                calendars: 1,
                format: "Y m d"
            });
            this_.dateTrigger = true;
            this_.startDateTrigger = true;
        }
        if (isPointInPoly(this_.endDateSelectPoly, params.mouseVal)) {
            jQuery("#fooDate").html("<div id=\"navDateCal\" style=\"position: absolute; top:" + (this_.windowHeight - this.padding - 100) + "px; left:" + (params.mouseVal.x - 50) + "px; width:auto\"></div>");
            jQuery('#navDateCal').DatePicker({
                flat: true,
                date: this.startDate.format('yyyy-mm-dd'),
                current: this.startDate.format('yyyy-mm-dd'),
                calendars: 1,
                format: "Y m d"
            });
            this_.dateTrigger = true;
            this_.endDateTrigger = true;
        }
        
        if (!this_.dateTrigger && this_.startDateTrigger) {
            this_.viz.initialize(this_.viz.canvas, this_.viz.windowWidth, this_.viz.windowHeight, this_.viz.timeZoneCorrect, this_.viz.zoom, parseInt(jQuery.datepicker.formatDate("@", new Date(jQuery('#navDateCal').DatePickerGetDate(true)))));
            jQuery("#fooDate").html("");
            this_.startDateTrigger = false;
        }
        if (!this_.dateTrigger && this_.endDateTrigger) {
            this_.viz.initialize(this_.viz.canvas, this_.viz.windowWidth, this_.viz.windowHeight, this_.viz.timeZoneCorrect, this_.viz.zoom, parseInt(jQuery.datepicker.formatDate("@", new Date(jQuery('#navDateCal').DatePickerGetDate(true)))));
            jQuery("#fooDate").html("");
            this_.endDateTrigger = false;
        }
    },
    mouseUp: function(){
        var this_ = this;
        
        if (this_.lIS) {
            this_.lSP = rectToPoly({
                xPos: this_.leftSlider + this_.xOffset,
                yPos: this_.windowHeight - this_.padding + this_.sliderTriTop + this_.yOffset,
                height: this_.sliderTriHeight,
                width: this_.sliderTriWidth
            });
        }
        if (this_.rIS) {
            this_.rSP = rectToPoly({
                xPos: this_.rightSlider + this_.xOffset - this.sliderTriWidth,
                yPos: this_.windowHeight - this_.padding + this_.sliderTriTop + this_.yOffset,
                height: this_.sliderTriHeight,
                width: this_.sliderTriWidth
            });
        }
        this_.rIS = false;
        this_.lIS = false;
    },
    initBarGraph: function(params){
        this_ = this;
        var fooObj = this_.viz.listit.CMS.event_store.getEvents("www-viewed", [this_.leftSliderDate, this_.rightSliderDate]);
        var barGraphVals = function(){
            var namesObj = {};
            var objArray = [];
            var fooName = "";
            var barFactory = ({
                initialize: function(params){
                    this.id = params.id;
                    this.value = params.value;
                }
            });
            var unknown = newify(barFactory, {
                id: "unknown",
                value: 0
            });
            objArray.push(unknown);
            for (var i = 0; i < fooObj.length; i++) {
                if (fooObj[i].entity.host) {
                    fooName = fooObj[i].entity.host;
                    
                    if (namesObj[fooName]) {
                        fooObj[i].entity.host.value += fooObj[i].end - fooObj[i].start;
                    }
                    else {
                        fooObj[i].entity.host = newify(barFactory, {
                            value: (fooObj[i].end - fooObj[i].start),
                            id: fooName.toString()
                        });
                        namesObj[fooName] = fooObj[i].entity.host;
                        objArray.push(namesObj[fooName]);
                    }
                }
                else {
                    unknown.value += fooObj[i].end - fooObj[i].start;
                }
            }
            objArray = objArray.objSort("value", -1, "id");
            return objArray;
        }();
        this_.barGraphVals = barGraphVals;
        this_.drawBarGraph();
    },
    drawBarGraph: function(params){
        var ctx = this_.canvas.getContext('2d');
        this_ = this;
        var fooPad = 20;
        var minTime = 0;
        var maxTime = function(){
            fooArray = [];
            for (var i = 0; i < 8; i++) {
                fooArray.push(this_.barGraphVals[i].value);
            }
            return fooArray.max();
        }();
        ctx.beginPath();
        ctx.lineWidth = 1;
        ctx.fillStyle = "#000000";
        ctx.font = "0.8pt helvetiker";
        
        ctx.fillText(this_.leftSliderDate.format("mmmm dS, h:MM TT") + " - " + this_.rightSliderDate.format("mmmm dS, h:MM TT"), (this_.rightSlider - this_.leftSlider) / 2 - 100 + this_.leftSlider, this_.padding + 10);
        ctx.strokeRect(this_.leftSlider + fooPad, this_.padding + fooPad, this_.rightSlider - this_.leftSlider - (fooPad * 2), this_.windowHeight - (this_.padding * 2) - (fooPad * 3));
        ctx.font = "0.7pt helvetiker";
        
        for (var i = 0; i < 8; i++) {
            ctx.fillStyle = "#000000";
            ctx.fillText(this_.barGraphVals[i].id, ((this_.rightSlider - this_.leftSlider - 40) / 8) * i + this_.leftSlider + 40, this_.windowHeight - this_.padding - 20);
            ctx.fillStyle = "#bbbbbb";
            
            ctx.fillText(timeCounterLongAbv(this_.barGraphVals[i].value / 1000), ((this_.rightSlider - this_.leftSlider - 40) / 8) * i + this_.leftSlider + 40, this_.padding + fooPad + 20);
            ctx.fillStyle = "hsl(" + (120 * ((this_.barGraphVals[i].value - minTime) / (maxTime - minTime)) + 180) + ",100%,55%)";
            ctx.fillRect(((this_.rightSlider - this_.leftSlider - 60) / 8) * i + this_.leftSlider + 60, this_.windowHeight - (this_.padding * 2), 20, -(this_.windowHeight - ((this_.padding + fooPad + (fooPad * 2)) * 2)) * ((this_.barGraphVals[i].value - minTime) / (maxTime - minTime)));
        }
        
        ctx.closePath();
    },
    zoomZoom: function(zoom){
        this_ = this;
        // 4 stages of zoom
        // keeps maxDate the same and expands the min 
        var fooZoom = 0;
        this_.zoom += zoom;
        if (this_.zoom < 0) {
            this_.zoom = 0;
        }
        if (this_.zoom > 3) {
            this_.zoom = 3;
        }
        if (this_.zoom == 0) {
            fooZoom = 86400000;
        }
        // 1 week
        if (this_.zoom == 1) {
            fooZoom = 604800000;
        }
        // 1 month
        if (this_.zoom == 2) {
            fooZoom = 604800000;
        }
        // 2 months
        if (this_.zoom == 3) {
            fooZoom = 1209600000;
        }
        this_.viz.initialize(this_.viz.canvas, this_.viz.windowWidth, this_.viz.windowHeight, this_.viz.timeZoneCorrect, fooZoom);
    }
});

// graph lines
var lineGraphFactory = ({
    initialize: function(viz, params){
        this.viz = viz;
        this.canvas = viz.getCanvas();
        this.startDate = viz.startDate;
        this.endDate = viz.endDate;
        this.startTime = viz.startTime;
        this.endTime = viz.endTime;
        this.OGstartTime = viz.startTime;
        this.OGendTime = viz.endTime;
        this.windowHeight = viz.windowHeight;
        this.windowWidth = viz.windowWidth;
        this.interp = viz.interp;
        this.padding = params.padding;
        this.topPadding = params.topPadding;
        this.dashed = params.dashed;
        this.color = params.color;
        this.key = params.key;       
	
	this.data = [];
	for (var i = 0; i < params.data.length; i++) {
	  this.data.push(params.data[i].start, params.data[i].end);
	}

        this.avg = params.avg
        this.setXY();
    },
    draw: function(){
        var ctx = this.canvas.getContext('2d');
        var this_ = this;
        ctx.beginPath();
        
        // check to see if there is a new value for max date time
	
	if ((this_.startTime !== this_.viz.startTime) || (this_.endTime !== this_.viz.endTime)) {
            this_.startTime = this_.viz.startTime;
            this_.endTime = this_.viz.endTime;
            this_.setXY();
        }        
        
        if (this_.dashed) {
            var testPaths = [], spacing = 2, firstDistance = 0, drawFirst = false, ctx, animating = false, pointerX = pointerY = 0, canvasOffset;
            
            function newTestPaths(){
                var fooPath = []
                for (var i = 1; i < this_.xPoints.length; i++) {
                    fooPath.push(new Bezier([new Point(this_.xPoints[i], this_.yPoints[i]), new Point(this_.xPoints[i - 1], this_.yPoints[i - 1])]));
                }
                return [new Path(fooPath)];
            }
            
            testPaths[0] = newTestPaths();
            
            ctx.beginPath();
            ctx.lineWidth = 1;
            ctx.strokeStyle = this_.color;
            testPaths.each(function(paths){
                paths.each(function(path){
                    path.makeDashedPath(ctx, spacing, firstDistance);
                });
            });
            ctx.stroke();
            ctx.closePath();
        }
        else {
            ctx.lineWidth = 2;
            ctx.strokeStyle = this_.color;
            ctx.moveTo(this_.xPoints[0], this_.yPoints[0]);
            for (var y = 1; y < this_.yPoints.length; y++) {
                ctx.lineTo(this_.xPoints[y], this_.yPoints[y]);
            }
            ctx.stroke();
        }
        
        if (this_.key) {
            ctx.beginPath();
            ctx.strokeStyle = "#333333";
            ctx.font = ".7pt helvetiker";
            ctx.fillStyle = "#333333";
            ctx.lineWidth = 0.5;
            ctx.fillText("" + this_.maxData, 9, this_.topPadding + 5);
            ctx.fillText("" + this_.minData, 9, this_.padding + 3);
            ctx.fillText("" + this_.maxData, this_.windowWidth - 19, this_.topPadding + 5);
            ctx.fillText("" + this_.minData, this_.windowWidth - 19, this_.padding + 3);
            for (var i = 0; i < 10; i++) {
                // ctx.strokeRect(20, 20, 60, 20);
            }
            
            ctx.closePath();
        }
        else {
            return
        }
        
        ctx.closePath();
    },
    mouseMove: function(params){
        var this_ = this;
    },
    mouseDown: function(){
        var this_ = this;
    },
    mouseUp: function(params){
      var this_ = this;
      if (params.p > 0) {
	// remove old stuff
	for (var i = this_.data.length - 1; i > 0; i--) {	  
	  if (this_.data[i] >= this_.endTime) {	    
	    foo = this_.data.length
	    this_.data = this_.data.slice(i, foo);
	    break;
	  }
	}
	for (var i = 0; i < params.newData.length; i++) {
	  this_.data.push(params.newData[i].start, params.newData[i].end);
	}
	
      } else {
	// remove old stuff
	for (var i = 0; i < this_.data.length; i++) {
	  if (this_.data[i] >= this_.endTime) {	    
	    this_.data = this_.data.slice(0, i);
	    break;
	  }
	}
	for (var i = 0; i < params.newData.length; i++) {
	  this_.data.unshift(params.newData[i].start, params.newData[i].end);
	}
      }

      this_.OGstartTime = this_.startTime;
      this_.OGendTime = this_.endTime;
      this_.setXY();
    },
    setXY: function(){
        var this_ = this;
        
        if (this_.avg) {
            this_.startTime = new Date().valueOf() - 15778458000;
        }
        
        var fooStartTime = Math.floor((this_.startTime / this_.interp)) * this_.interp;
        this_.count = (Math.floor((this_.endTime - this_.startTime) / this_.interp));
        
        this_.xPoints = [];
        this_.yPoints = [];
        this_.foo = [];
        
        var newWebViewed = function(){
            var counts = new Array(this_.count);

            this_.data.map(function(record){
                if (record > this_.endTime || record < this_.startTime) {
                    return;
                }
                var hour = Math.ceil((record - fooStartTime) / this_.interp);
                counts[hour] = counts[hour] === undefined ? 1 : counts[hour] + 1;
            });
            for (var i = 0; i < counts.length; i++) {
                if (counts[i] === undefined) {
                    counts[i] = 0;
                }
            }
            return counts;
        }();
	
        this_.minData = 0; // newWebViewed.min();
        // so that this is only computed on init
        if (!this_.maxData) {
            this_.maxData = newWebViewed.max(); // should find max of entire dataset
        }
        var fooX = function(){
            var foo = fooStartTime;
            var webHrArray = [];
            for (var i = 0; i < this_.count; i++) {
                webHrArray[i] = foo;
                foo += this_.interp;
            }
            return webHrArray;
        }();
        
        for (var i = 1; i < this_.count; i++) {
            this_.foo[i] = -(newWebViewed[i]);
            var wFoo = this_.windowWidth * ((fooX[i] - this_.startTime) / (this_.endTime - this_.startTime));
            var hFoo = ((this_.padding - this_.topPadding) * ((this_.foo[i] - this_.minData) / (this_.maxData - this_.minData)) + this_.padding);
            
            this_.xPoints.push(wFoo);
            this_.yPoints.push(hFoo);
        }

        if (this_.avg) {
            this_.yPoints = this_.avgCounts(this_.findStartIndex(this_.yPoints));
        }
    },
    findStartIndex: function(c){
        var this_ = this;
        
        var counts = function(){
            var foo = 0;
            
            for (var i = c.length - 1; i >= 0; i--) { // runs backwards through the array to find a place where there are lots of 0s
                if (c[i] < ((this_.padding - this_.topPadding) * ((1 - this_.minData) / (this_.maxData - this_.minData)) + this_.padding)) {
                    foo += 1;
                }
                else {
                    foo = 0;
                }
                if (foo > 50) { // number signifies the number of 0 to find before slicing
                    return i + foo;
                }
            }
        }
        c = c.slice(counts);
        return c;
    },
    avgCounts: function(p){
        var this_ = this;
        
        // this also may not work
        var numBlock = Math.round((this_.endTime - this_.startTime) / this_.interp);
        var counts = [];
        var n = Math.round(this_.count.length / ((this_.endTime - this_.startTime) / this_.interp)); // needs to be dynamic
        for (var i = 0; i < numBlock; i++) {
            counts[i] = (function(a){
                var foo = 0;
                for (var k = n - 1; k > -1; k--) {
                    if (p.counts[p.counts.length - i - numBlock * k]) {
                        foo += p.counts[p.counts.length - i - numBlock * k];
                    }
                }
                return foo / n;
            })();
        }
        return counts;
    }
});


var statusFactory = ({
    initialize: function(viz, params){
        this.viz = viz;
        this.canvas = viz.getCanvas();
        this.windowHeight = viz.windowHeight;
        this.windowWidth = viz.windowWidth;
        this.startTime = params.startTime;
        this.endTime = params.endTime;
        this.OGstartTime = this.startTime;
        this.OGendTime = this.endTime;
        this.xOffset = params.xOffset;
        this.yOffset = params.yOffset;
        this.color = params.color;
	this.marginTop = params.marginTop;
        this.height = params.height;
        this.data = params.data;
	this.pIH = undefined; // is hover
	this.static = params.static;
        this.trigger = false;
        this.setPos();
    },
    draw: function(){
        var ctx = this.canvas.getContext('2d');
        var this_ = this;
        
        // check to see if there is a new value for max date time	
        if (((this_.startTime !== this_.viz.startTime) || (this_.endTime !== this_.viz.endTime)) && !this_.static) {
            this_.startTime = this_.viz.startTime;
            this_.endTime = this_.viz.endTime;
            this_.movePos();
        }

        if (this_.trigger) {
            ctx.strokeStyle = "#00ff00";
        }
        else {
            ctx.strokeStyle = this_.color;
        }
        
	ctx.fillStyle = this_.color;	  
	for (var i = 0; i < this_.startPointArray.length; i++){
	  /*
	  if (this_.pIH) {
	    if (pointInPoly){
	      
	      jQuery("#fooTxt").html("<div class=\"friendStatus\" style=\"top:" + (this_.marginTop) + "px; left:" + (this_.startPoint + 46) + "px; background:#000000; color:#ffffff; padding:3px; width:auto \">" + this_.name + "</div>");
	      this_.trigger = true;
	    }
	  }
	  if (this_.viz.highlight === this_.domainArray[i]){
	    ctx.fillStyle = "#00ff00";
	  }
	  */
	  ctx.beginPath();	
	  ctx.fillRect(this_.startPointArray[i], this_.marginTop, this_.widthArray[i], this_.height);
	  ctx.closePath();
	  ctx.fillStyle = this_.color;	  
	}

        if (!(this_.pIH) && this_.trigger) {
            this_.trigger = false;
            jQuery("#fooTxt").html("");
        }
    },
    mouseMove: function(params){
        var this_ = this;
        
        this_.pIH = isPointInPoly(this_.poly, params.mouseVal);
    },
    mouseDown: function(){
    },
    mouseUp: function(params){
      var this_ = this;
      if (params.p > 0) {
	// remove old stuff
	for (var i = this_.data.length - 1; i > 0; i--) {	  
	  if (this_.data[i].start >= this_.endTime) {	    
	    foo = this_.data.length
	    this_.data = this_.data.slice(i, foo);
	    this_.domainArray = this_.domainArray.slice(i, foo);
	    this_.urlArray = this_.urlArray.slice(i, foo);
	    this_.startPointArray = this_.startPointArray.slice(i, foo);
	    this_.widthArray = this_.widthArray.slice(i, foo);
	    break;
	  }
	}

	var newData = params.newData;
	for (var i = 0; i < newData.length; i++) {
	  this_.data.push(newData[i]);
	  this_.domainArray.push(newData[i].entity.host);
	  this_.urlArray.push(newData[i].entity.id);
	  this_.startPointArray.push(this_.windowWidth * ((newData[i].start - this_.startTime) / (this_.endTime - this_.startTime)));
	  this_.widthArray.push((this_.windowWidth * ((newData[i].end - this_.startTime) / (this_.endTime - this_.startTime))) - this_.startPointArray[i]);
	}
	
      } else {
	// remove old stuff
	for (var i = 0; i < this_.data.length; i++) {
	  if (this_.data[i].start >= this_.endTime) {	    
	    this_.data = this_.data.slice(0, i);
	    this_.domainArray = this_.domainArray.slice(0, i);
	    this_.urlArray = this_.urlArray.slice(0, i);
	    this_.startPointArray = this_.startPointArray.slice(0, i);
	    this_.widthArray = this_.widthArray.slice(0, i);
	    break;
	  }
	}

	var newData = params.newData; 
	for (var i = 0; i < newData.length; i++) {
	  this_.data.unshift(newData[i]);
	  this_.domainArray.unshift(newData[i].entity.host);
	  this_.urlArray.unshift(newData[i].entity.id);
	  this_.startPointArray.unshift(this_.windowWidth * ((newData[i].start - this_.startTime) / (this_.endTime - this_.startTime)));
	  this_.widthArray.unshift((this_.windowWidth * ((newData[i].end - this_.startTime) / (this_.endTime - this_.startTime))) - this_.startPointArray[i]);	  
	}
      }

      this_.OGstartTime = this_.startTime;
      this_.OGendTime = this_.endTime;
      this_.movePos();
    },
    setPos: function(){
        var this_ = this;

	this_.domainArray = [];
	this_.urlArray = [];
        this_.startPointArray = [];
        this_.widthArray = [];
	
	for (var i = 0; i < this_.data.length; i++){
	  this_.domainArray[i] = this_.data[i].entity.host;
	  this_.urlArray[i] = this_.data[i].entity.id;
	  this_.startPointArray[i] = this_.windowWidth * ((this_.data[i].start - this_.startTime) / (this_.endTime - this_.startTime));
	  this_.widthArray[i] = (this_.windowWidth * ((this_.data[i].end - this_.startTime) / (this_.endTime - this_.startTime))) - this_.startPointArray[i];
	}
		
        this_.poly = rectToPoly({
            xPos: this_.xOffset,
            yPos: this_.marginTop - this_.yOffset,
            height: this_.height,
            width: this_.windowWidth - this_.yOffset
        });
    },
    movePos: function(){
        var this_ = this;

	for (var i = 0; i < this_.startPointArray.length; i++){
	  this_.startPointArray[i] = this_.windowWidth * ((this_.data[i].start - this_.startTime) / (this_.endTime - this_.startTime));
	  this_.widthArray[i] = (this_.windowWidth * ((this_.data[i].end - this_.startTime) / (this_.endTime - this_.startTime))) - this_.startPointArray[i];
	}
      }
    
});
